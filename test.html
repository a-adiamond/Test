<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-dark.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Testing</title>
  </head>

  <body>
    <div id="container">
      <div class="inner" id="head">

        <header>
          <h1>Diamond copy drafts</h1>
          <h2>V1.9</h2><h3>Now with spreadsheets!</h3>
        </header>

        <hr>
        

        <section id="main_content">
          <button id="signIn" onclick="authenticate()"><span>Sign in</span></button>
          <button id="loadDrafts" onclick="execute()" style="display:none"><span>Load drafts</span></button><br><br>
        <hr>
          <button id="signIn2" onclick="authenticate2()"><span>Sign in2</span></button>
          <button id="getDrafts" onclick="getNewDrafts()" style="display:none"><span>Get Draft IDs</span></button>
          <button id="deleteDrafts" onclick="getDelete()" style="display:none"><span>Delete existing</span></button>
          <button id="loadDrafts2" onclick="execute2()" style="display:none"><span>Import drafts</span></button></section>
        <section id="disp">
        </section>
      </div>
  </body>
          
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-base64/base64.min.js"></script>
    <script src="javascripts/Airtable.js"></script>
<script>
  /**
   * Sample JavaScript code for gmail.users.drafts.list
   * See instructions for running APIs Explorer code samples locally:
   * https://developers.google.com/explorer-help/guides/code_samples#javascript
   */
  
const draftSheet = "18r_XNtDoslk4MolJigMlRgshtteeumgydx5XCRzYg9c";
  
var drafts = [],
    draftObj = {},
    toDelete = [],
    sheetData = {};
  
function authenticate() {
  return gapi.auth2.getAuthInstance()
  .signIn({scope: "https://mail.google.com/ https://www.googleapis.com/auth/gmail.settings.sharing https://www.googleapis.com/auth/gmail.compose https://www.googleapis.com/auth/gmail.modify https://www.googleapis.com/auth/gmail.send https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/drive"})
  .then(function(response) { if (response.Ot.yu == "deancasbigbangmod@gmail.com") {loadClient();} else {console.error("Invalid login");}
                           }, 
        function(err) { console.error("Error signing in", err); });
}
function loadClient() {
  gapi.client.setApiKey("AIzaSyCKuhMTZwlwLNjo9AExurJZ0otGgBJGgq0");
  return gapi.client.load("https://content.googleapis.com/discovery/v1/apis/gmail/v1/rest")
  .then(function() {
    document.getElementById("loadDrafts").style.display = "block";},
        function(err) { console.error("Error loading GAPI client for API", err); });
}
// Make sure the client is loaded and sign-in is complete before calling this method.
function execute() {
  return gapi.client.gmail.users.drafts.list({
    "userId": "deancasbigbangmod@gmail.com"
  })
  .then(function(response) {
    // Handle the results here (response.result has the parsed body).
    for (var i in response.result.drafts) {
      var getDraft = response.result.drafts[i].message.id;
      getRaw(getDraft);
    }
        setTimeout(() => {  loadSheet();}, 1200);;
        setTimeout(() => {  getSheet();}, 2400);;

  },
        function(err) { console.error("Execute error", err); });
}

function getRaw(draftId) {
  return gapi.client.gmail.users.messages.get({
    "userId":"deancasbigbangmod@gmail.com",
    "id":draftId,
    "format":"raw"})
  .then(function(response) {
    drafts.push(draftId);
    draftObj[draftId] = Base64.decode(response.result.raw);
  },
        function(err) { console.error("Execute error", err); });
}
  
function loadSheet() {
  return gapi.client.load("https://content.googleapis.com/discovery/v1/apis/sheets/v4/rest")
    .then(function() {},
      function(err) { console.error("Error loading GAPI client for API", err); });
}
  
  function getSheet() {
    return gapi.client.sheets.spreadsheets.values.get({
      "spreadsheetId": "18r_XNtDoslk4MolJigMlRgshtteeumgydx5XCRzYg9c",
      "range": "a2:c30",
      "majorDimension": "COLUMNS"
    })
        .then(function(response) {
              buildSheet(response.result.values);
              document.getElementById("signIn2").style.borderColor = "#20b2aa";
              },
              function(err) { console.error("Execute error", err); });
  }


function buildSheet(values) {
  for (var i = 0; i < values[1].length; i++) {
    sheetData[values[1][i]] = {"name":values[0][i],"copy":values[2][i]};
  } 
}

function authenticate2() {
  return gapi.auth2.getAuthInstance()
  .signIn({scope: "https://mail.google.com/ https://www.googleapis.com/auth/gmail.settings.sharing https://www.googleapis.com/auth/gmail.compose https://www.googleapis.com/auth/gmail.modify https://www.googleapis.com/auth/gmail.send https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/drive"})
  .then(function(response) { if (response.Ot.yu == "adiamond@adiamond.net") {loadClient2();} else {console.error("Invalid login");}
                           }, 
        function(err) { console.error("Error signing in", err); });
}
function loadClient2() {
  gapi.client.setApiKey("AIzaSyCKuhMTZwlwLNjo9AExurJZ0otGgBJGgq0");
  return gapi.client.load("https://content.googleapis.com/discovery/v1/apis/gmail/v1/rest")
  .then(function() {document.getElementById("getDrafts").style.display = "block";
    document.getElementById("deleteDrafts").style.display = "block";},
        function(err) { console.error("Error loading GAPI client for API", err); });
}
// Make sure the client is loaded and sign-in is complete before calling this method.
function getDelete() {
  return gapi.client.gmail.users.drafts.list({
    "userId": "adiamond@adiamond.net"
  })
  .then(function(response) {
    doDelete(response.result.drafts.length);
    // Handle the results here (response.result has the parsed body).
    for (var i in response.result.drafts) {
      toDelete.push(response.result.drafts[i].message.id);
    }
  },
        function(err) { console.error("Execute error", err); });
}

function doDelete(limit) {
  if (toDelete.length == limit) {
   return gapi.client.gmail.users.messages.batchDelete({
     "userId":"adiamond@adiamond.net",
      "resource": {
        "ids": toDelete}})
  .then(function(response){     document.getElementById("loadDrafts2").style.display = "block";},        function(err) { console.error("Execute error", err); });
  }
 else {
    setTimeout(() => {  doDelete(limit);}, 1200);;
  }
}


function execute2() {
  if (drafts.length>0){
    var removed = drafts.pop();
    var base64EncodedEmail = Base64.encode(draftObj[removed]);
    return gapi.client.gmail.users.drafts.create({
      'userId': 'adiamond@adiamond.net',
      'resource': {
        'message': {
          'raw': base64EncodedEmail
        }
      }
    })
    .then(function(response){
      if (sheetData[removed]) {
        sheetData[removed].copy=response.result.message.id;
      }
      else {
        sheetData[removed] = {"copy":response.result.message.id,"name":""};
      };execute2()},
          function(err) { console.error("Execute error", err); });
  }
  else {
    document.getElementById("main_content").style.display="none";
    setTimeout(() => {  loadSheet();}, 1200);;
    setTimeout(() => {  updateSheet();}, 2400);;
  }
}
  
function updateSheet() {
  var newValues = [];
  var i = 0;
  for (id in sheetData) {
    newValues[i] = [sheetData[id].name,id,sheetData[id].copy];
    i++
  }
  return gapi.client.sheets.spreadsheets.values.update({
      "spreadsheetId": draftSheet,
      "range": "a2:c30",
      "valueInputOption": "RAW",
      "resource": {
        "majorDimension": "rows",
        "range": "a2:c30",
        "values": newValues}}).then(function(response){console.log("Maybe?");},function(err) {console.error(err);});
}

gapi.load("client:auth2", function() {
  gapi.auth2.init({client_id: "571192319172-stgjv6351t84a3gojdtglptnbp0tv0qs.apps.googleusercontent.com"});
});

</script>

        

</html>
