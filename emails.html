<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-dark.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>DCBB Emails</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>DCBB Emails</h1>
          <h2>V0.0.8.9.5</h2>
        </header>

        <hr>

        <section id="main_content">
          <button id="signIn" onclick="authenticate().then(loadClient)"><span>Sign in</span></button>
          <button id="loadDrafts" onclick="execute()" style="display:none"><span>Load Drafts</span></button>
        </section>
      </div>
      <form id="draft" onsubmit="event.preventDefault(); testFunction(this)" style="display:none">
        <div style="width: 50%; float:left"><h1>Which draft?</h1>
        <select name="draftSelect" id="draftSelect" onchange="updatePreview()">
        <option value="none" selected disabled hidden></option> 
        </select><input type="submit" id="continue" value="Continue"></div>
        <div style="border: thin solid black; width:50%; float:right" id="preview">Preview will show here</div>
      </form>
    </div>
  </body>
          
    <script src="https://apis.google.com/js/api.js"></script>
  <script src="javascripts/urlsafe-base64.js"></script>
<script>
  /**
   * Sample JavaScript code for gmail.users.drafts.list
   * See instructions for running APIs Explorer code samples locally:
   * https://developers.google.com/explorer-help/guides/code_samples#javascript
   */
  var URLSafeBase64 = require('urlsafe-base64');
  
  var drafts = {};
  var draftForm = document.getElementById("draft"),
      draftEl = document.getElementById("draftSelect"),
      preview = document.getElementById("preview");
  
  function authenticate() {
    return gapi.auth2.getAuthInstance()
        .signIn({scope: "https://mail.google.com/ https://www.googleapis.com/auth/gmail.compose https://www.googleapis.com/auth/gmail.modify https://www.googleapis.com/auth/gmail.readonly"})
        .then(function() { 
          //console.log("Sign-in successful"); 
        }, 
              function(err) { console.error("Error signing in", err); });
  }
  function loadClient() {
    gapi.client.setApiKey("AIzaSyCKuhMTZwlwLNjo9AExurJZ0otGgBJGgq0");
    return gapi.client.load("https://content.googleapis.com/discovery/v1/apis/gmail/v1/rest")
        .then(function() {
                 //console.log("GAPI client loaded for API");
                 document.getElementById("signIn").style.display="none";
                 document.getElementById("loadDrafts").style.display = "block";},
              function(err) { console.error("Error loading GAPI client for API", err); });
  }
  // Make sure the client is loaded and sign-in is complete before calling this method.
  function execute() {
    return gapi.client.gmail.users.drafts.list({
      "userId": "deancasbigbangmod@gmail.com"
    })
        .then(function(response) {
                // Handle the results here (response.result has the parsed body).
                for (var i in response.result.drafts) {
                  var getDraft = response.result.drafts[i].message.id;
                  getInfo(getDraft);
                }
                updateList(response.result.drafts.length);
              },
              function(err) { console.error("Execute error", err); });
  }
  
  function updateList(limit) {
    if (Object.keys(drafts).length == limit) {
      document.getElementById("loadDrafts").style.display="none";
      for (id in drafts) {
        var option = document.createElement("option");
        option.value = id;
        option.text = drafts[id]["subj"];
        draftEl.add(option);
      }
      draft.style.display = "inherit";
    }
    else {
      setTimeout(() => {  updateList(limit);}, 800);;
    }
  }
  
  function updatePreview() {
    console.log(drafts[draftEl.value]);
    preview.innerHTML = drafts[draftEl.value].bodyHTML;
  }
  
  function getInfo(draftId) {
    return gapi.client.gmail.users.messages.get({
                    "userId":"deancasbigbangmod@gmail.com",
                    "id":draftId,
                    "format":"full"})
    .then(function(response) {
      drafts[draftId] = {"subj" : response.result.payload.headers[3].value,
                        //"bodyPlain" : atob(response.result.payload.parts[0].body.data.replace(/-/g, '+').replace(/_/g, '/')),
                        "bodyHTML":URLSafeBase64.decode(response.result.payload.parts[1].body.data).toString()};
    },
          function(err) { console.error("Execute error", err); });
  }
  
  gapi.load("client:auth2", function() {
    gapi.auth2.init({client_id: "571192319172-stgjv6351t84a3gojdtglptnbp0tv0qs.apps.googleusercontent.com"});
  });
</script>

        

</html>
