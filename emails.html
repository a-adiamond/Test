<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-dark.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>DCBB Emails</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>DCBB Emails</h1>
          <h2>V0.3</h2>
        </header>

        <hr>

        <section id="main_content" style="display:none">
          <button id="signIn" onclick="authenticate().then(loadClient)"><span>Sign in</span></button>
          <button id="loadDrafts" onclick="execute()" style="display:none"><span>Load Drafts</span></button>
        </section>
      </div>
      <section id="draft" style="display:none">
        <h1>Which draft?</h1>
        <div style="width: 45%; float:left">
        <select name="draftSelect" id="draftSelect" onchange="updatePreview()">
        <option value="none" selected disabled hidden></option> 
        </select><button id="continueDraft" onclick="continueDraft()" style="display:none"><span>Continue</span></button></div>
        <div style="border: thin solid black; width:45%; float:right" id="previewDraft">Preview will show here</div>
      </section>
      <section id="recipient">
        <h1>Which group?</h1>
        <select name="recipientSelect" id="recipientSelect" onchange="loadRecipient()">
        <option value="none" selected disabled hidden></option>
        <option value="Authors">Authors</option>
        <option value="Artists">Artists</option>
        <option value="Author&Artists">Authors and Artists</option>
        <option value="Betas">Beta Readers</option>
        <option value="ACTIVE participants">All Participants</option>
        <option value="view">Other Airtable View</option>
        <option value="individual">Specific Emails</option>
      </select><button id="continueRecipient" onclick="continueRecipient()" style="display:none"><span>Continue</span></button></section>
        <section id="vars" style="display:none">
        <h1>Select your variables</h1>
        <div style="width: 45%; float:left">
          <span id="debug">Debug stuff here!</span>
          <button id="continueVars" onclick="continueVars()" style="display:none"><span>Continue</span></button></div>
        <div style="border: thin solid black; width:45%; float:right" id="previewVars">Preview will show here</div>
      </section>
    </div>
  </body>
          
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-base64/base64.min.js"></script>
    <script src="javascripts/Airtable.js"></script>
<script>
  /**
   * Sample JavaScript code for gmail.users.drafts.list
   * See instructions for running APIs Explorer code samples locally:
   * https://developers.google.com/explorer-help/guides/code_samples#javascript
   */
  
  var drafts = {};
  var draftForm = document.getElementById("draft"),
      draftEl = document.getElementById("draftSelect"),
      draftPre = document.getElementById("previewDraft"),
      recipForm = document.getElementById("recipient"),
      recipEl = document.getElementById("recipientSelect"),
      varForm = document.getElementById("vars"),
      varPre = document.getElementById("previewVars"),
      debug = document.getElementById("debug");
  
  var API_KEY = "keyJS9Lnv0F166zj2",
      baseId = "appf5kgjPnWM3kIJR",
      table;
  const samples = new Airtable.Table({
        name: "Participants",
        baseID: baseId,
        apiKey: API_KEY,
        view: "Diamond Samples"});
  
  function authenticate() {
    return gapi.auth2.getAuthInstance()
        .signIn({scope: "https://mail.google.com/ https://www.googleapis.com/auth/gmail.compose https://www.googleapis.com/auth/gmail.modify https://www.googleapis.com/auth/gmail.readonly"})
        .then(function() { 
          //console.log("Sign-in successful"); 
        }, 
              function(err) { console.error("Error signing in", err); });
  }
  function loadClient() {
    gapi.client.setApiKey("AIzaSyCKuhMTZwlwLNjo9AExurJZ0otGgBJGgq0");
    return gapi.client.load("https://content.googleapis.com/discovery/v1/apis/gmail/v1/rest")
        .then(function() {
                 //console.log("GAPI client loaded for API");
                 document.getElementById("signIn").style.display="none";
                 document.getElementById("loadDrafts").style.display = "block";},
              function(err) { console.error("Error loading GAPI client for API", err); });
  }
  // Make sure the client is loaded and sign-in is complete before calling this method.
  function execute() {
    return gapi.client.gmail.users.drafts.list({
      "userId": "deancasbigbangmod@gmail.com"
    })
        .then(function(response) {
                // Handle the results here (response.result has the parsed body).
                for (var i in response.result.drafts) {
                  var getDraft = response.result.drafts[i].message.id;
                  getInfo(getDraft);
                }
                updateList(response.result.drafts.length);
              },
              function(err) { console.error("Execute error", err); });
  }
  
  function updateList(limit) {
    if (Object.keys(drafts).length == limit) {
      document.getElementById("loadDrafts").style.display="none";
      for (id in drafts) {
        var option = document.createElement("option");
        option.value = id;
        option.text = drafts[id]["subj"];
        draftEl.add(option);
      }
      draft.style.display = "inherit";
    }
    else {
      setTimeout(() => {  updateList(limit);}, 800);;
    }
  }
  
  function updatePreview() {
    draftPre.innerHTML = drafts[draftEl.value].bodyHTML;
    document.getElementById("continueDraft").style.display="block";
  }
  
  function getInfo(draftId) {
    return gapi.client.gmail.users.messages.get({
                    "userId":"deancasbigbangmod@gmail.com",
                    "id":draftId,
                    "format":"full"})
    .then(function(response) {
      drafts[draftId] = {"subj" : response.result.payload.headers[3].value,
                        "bodyPlain" : Base64.decode(response.result.payload.parts[0].body.data),
                        "bodyHTML":Base64.decode(response.result.payload.parts[1].body.data)};
    },
          function(err) { console.error("Execute error", err); });
  }
  
  function continueDraft() {
    draftForm.style.display="none";
    recipForm.style.display="block";
  }
  
  function loadRecipient() {
    table = 
    console.log(recipEl.value);
    if (recipEl.value == "view" || recipEl.value == "individual") {
      console.log("Do this later");
    }
    else {
      table = new Airtable.Table({
        name: "Participants",
        baseID: baseId,
        apiKey: API_KEY,
        view: recipEl.value});
        setTimeout(() => {checkRecipient();}, 1000);
    }
  }
  
  function checkRecipient() {
    if (table) {
      document.getElementById("continueRecipient").style.display="block";
    }
    else {
      document.getElementById("continueRecipient").style.display="none";
      console.log("I have no table for you.");
    }
  }
  
  function continueRecipient() {
    recipForm.style.display="none";
    varForm.style.display="block";
    debug.innerText = "Sample fields: " + samples.fields().toString() + "\nRecipient fields: " + table.fields().toString();
  }
  
  
  
  
  gapi.load("client:auth2", function() {
    gapi.auth2.init({client_id: "571192319172-stgjv6351t84a3gojdtglptnbp0tv0qs.apps.googleusercontent.com"});
  });
</script>

        

</html>
