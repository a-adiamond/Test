<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Habitica Stuff</title>
  </head>
  <body onload="getStats()">
    <div id="container">
      <div class="inner" id="head">
        <header>
          <div style="display: inline-block;"><h1>Habitica Stuff</h1>
            <h2>V0.1.1</h2></div>
          <div style="display: inline-block;float: right;"><p><button id="buttonNotif" onclick="notif()">Show notifications</button></p><p><button id="buttonHabit" onclick="habtab()">Show habits</button></p><p><button id="buttonQuest">Pet Quests Page</button></p></div> 
        </header>
      </div>
      <hr>
      <section id="main_content" style="width:fit-content; margin-left:30%">
        <span style="font-size:xx-large">Bulk Armoire </span><input type="text" id="buyArmoire" value="0" min="0" max="100" style="font-size:xx-large; width:72px" oninput="checkVal(this.value)">  <button style="float:none;display:inline;vertical-align: super;" id="buyButt" onclick="disableButt(this.id); ntimes = parseInt(document.getElementById('buyArmoire').value); document.getElementById('buyArmoire').value = '0'; armoire(0)"><span >Buy</span></button><span id="buyInfo"></span><br>
        <span style="font-size:xx-large">Inn <button style="float:none;display:inline;vertical-align: middle;" id="buttonInn" onclick="disableButt(this.id); inn()"><span id="innButt">Check in</span></button>
      </section>
        <section id="display"><table id="notifTable" style="margin:auto;display:none"></table><table id="habTable" style="margin:auto;display:none"></table></section>
        </div>
  </body>
  <script>
    
    
    var habId = "eb5f51e6-cd0a-4590-b20c-5322bff97cc0";
    var habToken = "7b77d868-365d-484f-87fa-44ca42418238";
    var xhrResults;
    var habStats;
    var habits;
    var party;
    var debug;
    var ntimes;
    var buyEl = document.getElementById("buyInfo");
    var gained = {"experience":0,
                  "Meat":0,
                  "Milk":0,
                  "Potatoe":0,
                  "Strawberry":0,
                  "Chocolate":0,
                  "Fish":0,
                  "RottenMeat":0,
                  "CottonCandyPink":0,
                  "CottonCandyBlue":0,
                  "Honey":0};
    var gainedGear = [];
    const names = {"experience":["Experience","Experience"],
                  "Meat":["Meat","Meats"],
                  "Milk":["Milk","Milks"],
                  "Potatoe":["Potato","Potatoes"],
                  "Strawberry":["Strawberry","Strawberries"],
                  "Chocolate":["Chocolate","Chocolates"],
                  "Fish":["Fish","Fish"],
                  "RottenMeat":["Rotten Meat","Rotten Meats"],
                  "CottonCandyPink":["Pink Cotton Candy","Pink Cotton Candies"],
                  "CottonCandyBlue":["Blue Cotton Candy","Blue Cotton Candies"],
                  "Honey":["Honey","Honeys"]}
    var notifs = [],
        notifEl = document.getElementById("notifTable"),
        habEl = document.getElementById("habTable");
    
    var url;
    var sleepTime = 1500; // 1.5 seconds
    
    function testXHR(xurl, method) {
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          xhrResults = JSON.parse(this.responseText);
        }
      };
      xhr.open(method,xurl);
      xhr.setRequestHeader("x-api-user", habId);
      xhr.setRequestHeader("x-api-key", habToken);
      xhr.setRequestHeader("x-client", "eb5f51e6-cd0a-4590-b20c-5322bff97cc0-Testing-Personal");
      xhr.send();
    }
    
    function getStats() {
      document.getElementById("buyArmoire").addEventListener("focusin", function() {if (parseInt(document.getElementById("buyArmoire").value) == 0) {document.getElementById("buyArmoire").value="";}});
      document.getElementById("buyArmoire").addEventListener("focusout", function() {if (document.getElementById("buyArmoire").value == "") {document.getElementById("buyArmoire").value="0";}});
      url = "https://habitica.com/api/v3/user";
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          habStats = JSON.parse(this.responseText);
          getHabits();
          if (habStats.data.preferences.sleep == true) {
            document.getElementById("innButt").innerText = "Check Out";
          }
          if (habStats.data.stats.gp < 100) {
            document.getElementById("buyArmoire").max = 0;
            disableButt("buyButt");
          }
          else {
            document.getElementById("buyArmoire").max = Math.trunc(habStats.data.stats.gp / 100);
          }
          if (habStats.notifications) {
            for (var i in habStats.notifications) {
              var notif = habStats.notifications[i];
              if (notif.type == "GROUP_INVITE_ACCEPTED") {
                notifs.push([notif.id, notif.data.bodyText]);
              }
              else if (notif.type == "NEW_CHAT_MESSAGE") {
                notifs.push([notif.id,"New message in " + notif.data.group.name]);
              }
              else if (notif.type == "UNALLOCATED_STATS_POINTS") {
                notifs.push([notif.id,notif.data.points + " unallocated stat points"]);
              }
            }
            for (var i in notifs) {
              var row = notifEl.insertRow(notifEl.rows.length);
              var cell1 = row.insertCell(0);
              var cell2 = row.insertCell(1);
              cell1.innerText = notifs[i][1];
              cell2.innerHTML = "<button onclick=\"notifEl.rows["+i+"].style.display = 'none';markRead('"+notifs[i][0]+"')\"><span>Mark read</span></button>";
            }
          }
        }
      };
      xhr.open('GET',url);
      xhr.setRequestHeader("x-api-user", habId);
      xhr.setRequestHeader("x-api-key", habToken);
      xhr.setRequestHeader("x-client", "eb5f51e6-cd0a-4590-b20c-5322bff97cc0-Testing-Personal");
      xhr.send();
    }
    
    function getHabits() {
      
      url = "https://habitica.com/api/v3/tasks/user?type=habits";
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          habits = JSON.parse(this.responseText);
          getParty();
          for (var i in habits.data) {
            var row = habEl.insertRow(habEl.rows.length);
            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);
            var cell3 = row.insertCell(2);
            var cell4 = row.insertCell(3);
            cell1.innerText = habits.data[i].text;
            cell2.innerHTML = '<input type="text" name="'+habits.data[i].text+'" id="'+habits.data[i].id+'" value="0" min="0" max="100" style="width:24px">'
            if (habits.data[i].up == true) {
              cell3.innerHTML = '<button onclick="doHab(\'up\',\''+habits.data[i].id+'\',0)">⬆️</button>';
            }
            if (habits.data[i].down == true) {
              cell4.innerHTML = '<button onclick="doHab(\'down\',\''+habits.data[i].id+'\',0)">⬇️</button>';
            }
          }
        }   
      };
      xhr.open('GET',url);
      xhr.setRequestHeader("x-api-user", habId);
      xhr.setRequestHeader("x-api-key", habToken);
      xhr.setRequestHeader("x-client", "eb5f51e6-cd0a-4590-b20c-5322bff97cc0-Testing-Personal");
      xhr.send();
    }
    
    
    function getParty() {
      
      url = "https://habitica.com/api/v3/groups/party/members";
      var questUrl = 'https://habiticapartytools.surge.sh/?users=';
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          party = JSON.parse(this.responseText);
          for (var i in party.data) {
            questUrl += party.data[i]._id + '|';
          }
          document.getElementById('buttonQuest').onclick = function(){window.open(questUrl.slice(0,-1))};
        }   
      };
      xhr.open('GET',url);
      xhr.setRequestHeader("x-api-user", habId);
      xhr.setRequestHeader("x-api-key", habToken);
      xhr.setRequestHeader("x-client", "eb5f51e6-cd0a-4590-b20c-5322bff97cc0-Testing-Personal");
      xhr.send();
    }
      
    
    function inn() {
      url = "https://habitica.com/api/v3/user/sleep";
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          setTimeout(() => {enableButt("innButt");}, sleepTime);
          habStats.data.preferences.sleep = JSON.parse(this.responseText).data;
          if (JSON.parse(this.responseText).data == true) {
            document.getElementById("innButt").innerText = "Check Out";
          }
          else {
            document.getElementById("innButt").innerText = "Check In";
          }
        }
      };
      xhr.open('POST',url);
      xhr.setRequestHeader("x-api-user", habId);
      xhr.setRequestHeader("x-api-key", habToken);
      xhr.setRequestHeader("x-client", "eb5f51e6-cd0a-4590-b20c-5322bff97cc0-Testing-Personal");
      xhr.send();
    }
    
    function enableButt(button) {
      document.getElementById(button).disabled = false;
      document.getElementById(button).style.color = "#303030";
    }
    
    function disableButt(button) {
      document.getElementById(button).disabled = true;
      document.getElementById(button).style.color = "#ababab";
    }
    
    function checkVal(val) {
      if (val.match(/^([0-9]+)$/)) {
        if (parseInt(val) > parseInt(document.getElementById("buyArmoire").max)) {
          document.getElementById("buyArmoire").value = document.getElementById("buyArmoire").max;
        }
      }
      else if (val.match(/^([0-9]+)\.$/)) {
        document.getElementById("buyArmoire").value = parseInt(val).toString();
      }
      else {
        document.getElementById("buyArmoire").value = "";
      }
    }
   
    function armoire(iter) {
      if (ntimes == 0) {
        enableButt("buyButt");
      }
      else if (iter < ntimes) {
        buyEl.innerText = "Buying " + (iter+1) + "/" + ntimes + "...";
        url = "https://habitica.com/api/v3/user/buy-armoire";
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            debug = JSON.parse(this.responseText);
            habStats.data.stats.gp -= 100;
            document.getElementById("buyArmoire").max -= 1;
            if (debug.data.armoire.type == 'food') {
             buyEl.innerText = "Bought " + (iter+1) + "/" + ntimes + ": " + debug.data.armoire.dropText;
             gained[debug.data.armoire.dropKey]++;
            }
            else if (debug.data.armoire.type == 'gear') {
             buyEl.innerText = "Bought " + (iter+1) + "/" + ntimes + ": " + debug.data.armoire.dropText;
             gainedGear.push(debug.data.armoire.dropText);
            }

            else {
             buyEl.innerText = "Bought " + (iter+1) + "/" + ntimes + ": " + debug.data.armoire.type;
             gained[debug.data.armoire.type] += debug.data.armoire.value;
            }
            if (iter + 1 == ntimes) {
              armoire(iter+1);
            }
            else if (iter % 10 == 9) { // extra long pause after every 10 to keep the load down
              setTimeout(() => {armoire(iter+1);}, 5000);
            }
            else {
              setTimeout(() => {armoire(iter+1);}, sleepTime);
            }
          }
          else if (this.readyState == 4) {
            console.log(this.status + " " + this.responseText);
          }
        }
        xhr.open('POST',url);
        xhr.setRequestHeader("x-api-user", habId);
        xhr.setRequestHeader("x-api-key", habToken);
        xhr.setRequestHeader("x-client", "eb5f51e6-cd0a-4590-b20c-5322bff97cc0-Testing-Personal");
        xhr.send();
      }
      else if (iter = ntimes) {
        buyEl.innerText = "";
        var gainList = "";
        for (var armTyp in gained) {
          if (gained[armTyp] == 1) {
            gainList += "\n - " + gained[armTyp] + " " + names[armTyp][0];
          }
          else if (gained[armTyp] > 1) {
            gainList += "\n - " + gained[armTyp] + " " + names[armTyp][1];
          }
        }
        if (gainedGear.length>0) {
          gainList += "\n - " + gainedGear.join(", ");
        }
        alert("You gained the following:"+gainList);
        console.log("Gained: " + JSON.stringify(gained));
        enableButt("buyButt");
        gained = {"experience":0,
                  "Meat":0,
                  "Milk":0,
                  "Potatoe":0,
                  "Strawberry":0,
                  "Chocolate":0,
                  "Fish":0,
                  "RottenMeat":0,
                  "CottonCandyPink":0,
                  "CottonCandyBlue":0,
                  "Honey":0};
      gainedGear = [];
      }
    }
      
    function markRead(id) {
      url = "https://habitica.com/api/v3/notifications/"+id+"/read";
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          debug = JSON.parse(this.responseText);
          console.log(debug);
        }
      };
      xhr.open('POST',url);
      xhr.setRequestHeader("x-api-user", habId);
      xhr.setRequestHeader("x-api-key", habToken);
      xhr.setRequestHeader("x-client", "eb5f51e6-cd0a-4590-b20c-5322bff97cc0-Testing-Personal");
      xhr.send();
    }
    
    function notif(state) {
      var butttt = document.getElementById("buttonNotif"),
          tabbbb = document.getElementById("notifTable");
      if (state == "hide") {
        tabbbb.style.display = "none";
        butttt.innerText = "Show notifications";
      }
      else if (state == "show" || tabbbb.style.display == "none") {
        tabbbb.style.display = "revert";
        butttt.innerText = "Hide notifications";
        habtab('hide');
      }
      else {
        tabbbb.style.display = "none";
        butttt.innerText = "Show notifications";
      }
    }
    
    function habtab(state) {
      var butttt = document.getElementById("buttonHabit"),
          tabbbb = document.getElementById("habTable");
      if (state == "hide") {
        tabbbb.style.display = "none";
        butttt.innerText = "Show habits";
      }
      else if (state == "show" || tabbbb.style.display == "none") {
        tabbbb.style.display = "revert";
        butttt.innerText = "Hide habits";
        notif('hide');
      }
      else {
        tabbbb.style.display = "none";
        butttt.innerText = "Show habits";
      }
    }
    
    function doHab(dir, id, iter) {
      if (iter < parseInt(document.getElementById(id).value)) {
        buyEl.innerText = "Scoring habit " + document.getElementById(id).name + " " + dir + " " + (iter+1) + "/" + document.getElementById(id).value + " times";
        habtab('hide');
        url = "https://habitica.com/api/v3/tasks/"+id+"/score/"+dir;
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            if (iter + 1 == parseInt(document.getElementById(id).value)) {
              doHab(dir,id,iter+1);
            }
            else if (iter % 10 == 9) { // extra long pause after every 10 to keep the load down
              setTimeout(() => {doHab(dir,id,iter+1);}, 5000);
            }
            else {
              setTimeout(() => {doHab(dir,id,iter+1);}, sleepTime);
            }
          }
        };
        xhr.open('POST',url);
        xhr.setRequestHeader("x-api-user", habId);
        xhr.setRequestHeader("x-api-key", habToken);
        xhr.setRequestHeader("x-client", "eb5f51e6-cd0a-4590-b20c-5322bff97cc0-Testing-Personal");
        xhr.send();
      }
      else {
        document.getElementById(id).value = 0;
        buyEl.innerText = "";
        habtab('show');
      }
    }
        
        
  
  </script>
</html>

