<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-dark.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Habitica Stuff</title>
  </head>
  <body onload="getStats()">
    <div id="container">
      <div class="inner" id="head">
        <header>
          <h1>Habitica Stuff</h1>
          <h2>V0.0.7</h2>
        </header>
      </div>
      <hr>
      <section id="main_content" style="width:fit-content; margin:auto">
        <span style="font-size:xx-large">Bulk Armoire </span><input type="text" id="buyArmoire" value="0" min="0" max="100" style="font-size:xx-large; width:72px" oninput="checkVal(this.value)">  <button style="float:none;display:inline;vertical-align: super;" id="buyButt" onclick="this.disabled = true; this.style.color = '#ababab'; ntimes = parseInt(document.getElementById('buyArmoire').value); document.getElementById('buyArmoire').value = '0'; armoire(0)"><span>Buy</span></button><br>
        <span style="font-size:xx-large">Inn <button style="float:none;display:inline;vertical-align: middle;" onclick="inn()"><span id="innButt">Check in</span></button>
      </section>
    </div>
  </body>
  <script>
    
    
    var habId = "eb5f51e6-cd0a-4590-b20c-5322bff97cc0";
    var habToken = "7b77d868-365d-484f-87fa-44ca42418238";
    var habStats;
    var debug;
    var ntimes;
    var gained = {"experience":0,
                  "Meat":0,
                  "Milk":0,
                  "Potatoe":0,
                  "Strawberry":0,
                  "Chocolate":0,
                  "Fish":0,
                  "RottenMeat":0,
                  "CottonCandyPink":0,
                  "CottonCandyBlue":0,
                  "Honey":0};
    const names = {"experience":["Experience","Experience"],
                  "Meat":["Meat","Meats"],
                  "Milk":["Milk","Milks"],
                  "Potatoe":["Potato","Potatoes"],
                  "Strawberry":["Strawberry","Strawberries"],
                  "Chocolate":["Chocolate","Chocolates"],
                  "Fish":["Fish","Fish"],
                  "RottenMeat":["Rotten Meat","Rotten Meats"],
                  "CottonCandyPink":["Pink Cotton Candy","Pink Cotton Candies"],
                  "CottonCandyBlue":["Pink Cotton Candy","Pink Cotton Candies"],
                  "Honey":["Honey","Honeys"]};
                  
    
    var url;
    var sleepTime = 200;
    
    function getStats() {
      document.getElementById("buyArmoire").addEventListener("focusin", function() {if (parseInt(document.getElementById("buyArmoire").value) == 0) {document.getElementById("buyArmoire").value="";}});
      document.getElementById("buyArmoire").addEventListener("focusout", function() {if (document.getElementById("buyArmoire").value == "") {document.getElementById("buyArmoire").value="0";}});
      url = "https://habitica.com/api/v3/user";
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          habStats = JSON.parse(this.responseText);
          if (habStats.data.preferences.sleep == true) {
            document.getElementById("innButt").innerText = "Check Out";
          }
          if (habStats.data.stats.gp < 100) {
            document.getElementById("buyButt").disabled = true;
          }
          else {
            document.getElementById("buyArmoire").max = Math.trunc(habStats.data.stats.gp / 100);
          }
        }
      };
      xhr.open('GET',url);
      xhr.setRequestHeader("x-api-user", habId);
      xhr.setRequestHeader("x-api-key", habToken);
      xhr.setRequestHeader("x-client", "eb5f51e6-cd0a-4590-b20c-5322bff97cc0-Testing-Personal");
      xhr.send();
    }
      
    
    function inn() {
      url = "https://habitica.com/api/v3/user/sleep";
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          habStats.data.preferences.sleep = JSON.parse(this.responseText).data;
          if (JSON.parse(this.responseText).data == true) {
            document.getElementById("innButt").innerText = "Check Out";
          }
          else {
            document.getElementById("innButt").innerText = "Check In";
          }
        }
      };
      xhr.open('POST',url);
      xhr.setRequestHeader("x-api-user", habId);
      xhr.setRequestHeader("x-api-key", habToken);
      xhr.setRequestHeader("x-client", "eb5f51e6-cd0a-4590-b20c-5322bff97cc0-Testing-Personal");
      xhr.send();
    }
    
    function checkVal(val) {
      if (val.match(/^([0-9]+)$/)) {
        if (parseInt(val) > parseInt(document.getElementById("buyArmoire").max)) {
          document.getElementById("buyArmoire").value = document.getElementById("buyArmoire").max;
        }
      }
      else if (val.match(/^([0-9]+)\.$/)) {
        document.getElementById("buyArmoire").value = parseInt(val).toString();
      }
      else {
        document.getElementById("buyArmoire").value = "";
      }
    }
   
    function armoire(iter) {
      if (ntimes == 0) {
        document.getElementById("buyButt").disabled = false;
        document.getElementById("buyButt").style.color = "#303030";
      }
      else if (iter < ntimes) {
        url = "https://habitica.com/api/v3/user/buy-armoire";
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            habStats.data.stats.gp -= 100;
            document.getElementById("buyArmoire").max -= 1;
            debug = JSON.parse(this.responseText);
            if (debug.data.armoire.type == 'food') {
             gained[debug.data.armoire.dropKey]++;
            }
            else {
             gained[debug.data.armoire.type] += debug.data.armoire.value;
            }
            console.log(iter+1 + "/" + ntimes + " bought.");
            setTimeout(() => {armoire(iter+1);}, sleepTime);
          }
        };
        xhr.open('POST',url);
        xhr.setRequestHeader("x-api-user", habId);
        xhr.setRequestHeader("x-api-key", habToken);
        xhr.setRequestHeader("x-client", "eb5f51e6-cd0a-4590-b20c-5322bff97cc0-Testing-Personal");
        xhr.send();
      }
      else if (iter = ntimes) {
        var gainList = "";
        for (var armTyp in gained) {
          if (gained[armTyp] == 1) {
            gainList += "\n - " + gained[armTyp] + " " + names[armTyp][0];
          }
          else if (gained[armTyp] > 1) {
            gainList += "\n - " + gained[armTyp] + " " + names[armTyp][1];
          }
        }
        alert("You gained the following:"+gainList);
        console.log("Gained: " + JSON.stringify(gained));
        document.getElementById("buyButt").disabled = false;
        document.getElementById("buyButt").style.color = "#303030";
      }
    }
        
  
  </script>
</html>

